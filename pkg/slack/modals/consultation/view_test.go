package consultation

import (
	"testing"

	jiraapi "github.com/andygrunwald/go-jira"
	"github.com/slack-go/slack"

	"github.com/openshift/ci-tools/pkg/jira"
	"github.com/openshift/ci-tools/pkg/slack/modals"
	"github.com/openshift/ci-tools/pkg/slack/modals/modaltesting"
)

func TestProcessSubmissionHandler(t *testing.T) {
	happyPath := modaltesting.SubmissionTestCase{
		Name:     "happy path with additional details",
		Callback: []byte(`{"type":"view_submission","token":"Rn1sVT099UjUeKclB3PkLT8t","callback_id":"","response_url":"","trigger_id":"1416756610774.1377252349923.ff1a76bce3db8f1d6f892f75bcb25f58","action_ts":"","team":{"id":"T01B37EA9T5","name":"","domain":"dptp-robot-testing"},"channel":{"id":"","created":0,"is_open":false,"is_group":false,"is_shared":false,"is_im":false,"is_ext_shared":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_mpim":false,"unlinked":0,"name_normalized":"","num_members":0,"priority":0,"user":"","name":"","creator":"","is_archived":false,"members":null,"topic":{"value":"","creator":"","last_set":0},"purpose":{"value":"","creator":"","last_set":0},"is_channel":false,"is_general":false,"is_member":false,"locale":""},"user":{"id":"U01B31ARZDG","team_id":"T01B37EA9T5","name":"skuznets","deleted":false,"color":"","real_name":"","tz_label":"","tz_offset":0,"profile":{"first_name":"","last_name":"","real_name":"","real_name_normalized":"","display_name":"","display_name_normalized":"","email":"","skype":"","phone":"","image_24":"","image_32":"","image_48":"","image_72":"","image_192":"","image_original":"","title":"","status_expiration":0,"team":"","fields":[]},"is_bot":false,"is_admin":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_ultra_restricted":false,"is_stranger":false,"is_app_user":false,"is_invited_user":false,"has_2fa":false,"has_files":false,"presence":"","locale":"","updated":0,"enterprise_user":{"id":"","enterprise_id":"","enterprise_name":"","is_admin":false,"is_owner":false,"teams":null}},"original_message":{"replace_original":false,"delete_original":false,"blocks":null},"message":{"replace_original":false,"delete_original":false,"blocks":null},"name":"","value":"","message_ts":"","attachment_id":"","actions":[],"view":{"ok":false,"error":"","id":"V01CU3D2A73","team_id":"T01B37EA9T5","type":"modal","title":{"type":"plain_text","text":"Request a Consultation","emoji":true},"close":{"type":"plain_text","text":"Cancel","emoji":true},"submit":{"type":"plain_text","text":"Submit","emoji":true},"blocks":[{"type":"section","text":{"type":"plain_text","text":"When a team has complex or involved requirements from the infrastructure, the Test Platform team can provide an engineer's time to consult on how to best achieve those goals. Use this form to request a consultation.","emoji":true},"block_id":"zrDa"},{"type":"section","text":{"type":"plain_text","text":"Users that wish to ask a question from the Test Platform Help-Desk engineer should use the question form instead.","emoji":true},"block_id":"yIBe","accessory":{"type":"button","text":{"type":"plain_text","text":"Ask a Question","emoji":true},"action_id":"MGG","value":"question"}},{"type":"divider","block_id":"fwY8"},{"type":"input","block_id":"title","label":{"type":"plain_text","text":"Provide a one-line summary for this consultation:","emoji":true},"element":{"type":"plain_text_input","action_id":"xFGTt"}},{"type":"input","block_id":"requirement","label":{"type":"plain_text","text":"Explain your goals (what are you trying to achieve using the test platform?):","emoji":true},"element":{"type":"plain_text_input","action_id":"6v7u","multiline":true}},{"type":"input","block_id":"previous","label":{"type":"plain_text","text":"Explain what you've tried already and list any documents that were helpful or insufficient:","emoji":true},"element":{"type":"plain_text_input","action_id":"XwW0","multiline":true}},{"type":"input","block_id":"acceptance_criteria","label":{"type":"plain_text","text":"Provide acceptance criteria (one per line) for this consultation, focusing on what is to be achieved, not how:","emoji":true},"element":{"type":"plain_text_input","action_id":"ec8","multiline":true}},{"type":"input","block_id":"additional","label":{"type":"plain_text","text":"Provide any additional information:","emoji":true},"element":{"type":"plain_text_input","action_id":"aPFdZ","multiline":true},"optional":true}],"private_metadata":"consultation","callback_id":"","state":{"values":{"acceptance_criteria":{"ec8":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"something simple is done\nI didn't have to do anything to achieve it","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"additional":{"aPFdZ":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I'll bug you forever while we work on this.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"previous":{"XwW0":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I have tried nothing and looked at no docs.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"requirement":{"6v7u":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I would like to do something really simple.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"title":{"xFGTt":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"Please Help Me","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}}}},"hash":"1602538261.7V8X4IBr","clear_on_close":false,"notify_on_close":false,"root_view_id":"V01CU3D2A73","previous_view_id":"","app_id":"A01BJF00CAD","external_id":"","bot_id":"B01B63T6ZFD"},"action_id":"","api_app_id":"A01BJF00CAD","block_id":"","container":{"type":"","view_id":"","message_ts":"","attachment_id":0,"channel_id":"","is_ephemeral":false,"is_app_unfurl":false},"submission":null,"hash":"","is_cleared":false}`),
		Filer: jira.NewFake(map[jira.IssueRequest]jira.IssueResponse{
			{
				IssueType: "Request",
				Title:     "Please Help Me",
				Description: `h3. Requirement
I would like to do something really simple.

h3. Previous Efforts
I have tried nothing and looked at no docs.

h3. Acceptance Criteria
* something simple is done
* I didn't have to do anything to achieve it

h3. Additional Details
I'll bug you forever while we work on this.`,
				Reporter: "U01B31ARZDG",
			}: {
				Issue: &jiraapi.Issue{Key: "WHOA-123"},
				Error: nil,
			},
		}),
		Updater: modals.NewFake([]modals.ViewUpdate{
			{
				ViewUpdateRequest: modals.ViewUpdateRequest{
					View:       modals.JiraView("WHOA-123"),
					ExternalID: "",
					Hash:       "", // updated unconditionally, should be empty
					ViewID:     "V01CU3D2A73",
				},
				ViewUpdateResponse: modals.ViewUpdateResponse{
					Response: &slack.ViewResponse{},
					Error:    nil,
				},
			},
		}),
		ExpectedPayload: []byte(`{"response_action":"update","view":{"type":"modal","title":{"type":"plain_text","text":"Creating Jira Issue..."},"blocks":[{"type":"section","text":{"type":"mrkdwn","text":"A Jira issue is being filed, please do not close this window..."}}],"private_metadata":"jira_pending"}}`),
		ExpectedError:   false,
	}
	modaltesting.ValidateSubmission(t, processSubmissionHandler(happyPath.Filer, happyPath.Updater), happyPath)
}

func TestIssueParameters(t *testing.T) {
	parameters := issueParameters()
	modaltesting.ValidateBlockIds(t, View(), parameters.Fields...)
	modaltesting.ValidateParameterProcessing(t, parameters, []modaltesting.ProcessTestCase{
		{
			Name:          "one acceptance criteria, no additional details",
			Callback:      []byte(`{"type":"view_submission","token":"Rn1sVT099UjUeKclB3PkLT8t","callback_id":"","response_url":"","trigger_id":"1429676731732.1377252349923.55259e6c220e0f2b07ab17ced3a30ea7","action_ts":"","team":{"id":"T01B37EA9T5","name":"","domain":"dptp-robot-testing"},"channel":{"id":"","created":0,"is_open":false,"is_group":false,"is_shared":false,"is_im":false,"is_ext_shared":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_mpim":false,"unlinked":0,"name_normalized":"","num_members":0,"priority":0,"user":"","name":"","creator":"","is_archived":false,"members":null,"topic":{"value":"","creator":"","last_set":0},"purpose":{"value":"","creator":"","last_set":0},"is_channel":false,"is_general":false,"is_member":false,"locale":""},"user":{"id":"U01B31ARZDG","team_id":"T01B37EA9T5","name":"skuznets","deleted":false,"color":"","real_name":"","tz_label":"","tz_offset":0,"profile":{"first_name":"","last_name":"","real_name":"","real_name_normalized":"","display_name":"","display_name_normalized":"","email":"","skype":"","phone":"","image_24":"","image_32":"","image_48":"","image_72":"","image_192":"","image_original":"","title":"","status_expiration":0,"team":"","fields":[]},"is_bot":false,"is_admin":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_ultra_restricted":false,"is_stranger":false,"is_app_user":false,"is_invited_user":false,"has_2fa":false,"has_files":false,"presence":"","locale":"","updated":0,"enterprise_user":{"id":"","enterprise_id":"","enterprise_name":"","is_admin":false,"is_owner":false,"teams":null}},"original_message":{"replace_original":false,"delete_original":false,"blocks":null},"message":{"replace_original":false,"delete_original":false,"blocks":null},"name":"","value":"","message_ts":"","attachment_id":"","actions":[],"view":{"ok":false,"error":"","id":"V01CCCHC7U5","team_id":"T01B37EA9T5","type":"modal","title":{"type":"plain_text","text":"Request a Consultation","emoji":true},"close":{"type":"plain_text","text":"Cancel","emoji":true},"submit":{"type":"plain_text","text":"Submit","emoji":true},"blocks":[{"type":"section","text":{"type":"plain_text","text":"When a team has complex or involved requirements from the infrastructure, the Test Platform team can provide an engineer's time to consult on how to best achieve those goals. Use this form to request a consultation.","emoji":true},"block_id":"Z7X+"},{"type":"section","text":{"type":"plain_text","text":"Users that wish to ask a question from the Test Platform Help-Desk engineer should use the question form instead.","emoji":true},"block_id":"iUax","accessory":{"type":"button","text":{"type":"plain_text","text":"Ask a Question","emoji":true},"action_id":"rlk","value":"question"}},{"type":"divider","block_id":"qqzS"},{"type":"input","block_id":"title","label":{"type":"plain_text","text":"Provide a one-line summary for this consultation:","emoji":true},"element":{"type":"plain_text_input","action_id":"8YZh"}},{"type":"input","block_id":"requirement","label":{"type":"plain_text","text":"Explain your goals (what are you trying to achieve using the test platform?):","emoji":true},"element":{"type":"plain_text_input","action_id":"y1+","multiline":true}},{"type":"input","block_id":"previous","label":{"type":"plain_text","text":"Explain what you've tried already and list any documents that were helpful or insufficient:","emoji":true},"element":{"type":"plain_text_input","action_id":"Y4r7m","multiline":true}},{"type":"input","block_id":"acceptance_criteria","label":{"type":"plain_text","text":"Provide acceptance criteria (one per line) for this consultation, focusing on what is to be achieved, not how:","emoji":true},"element":{"type":"plain_text_input","action_id":"BCC","multiline":true}},{"type":"input","block_id":"additional","label":{"type":"plain_text","text":"Provide any additional information:","emoji":true},"element":{"type":"plain_text_input","action_id":"S47AD","multiline":true},"optional":true}],"private_metadata":"consultation","callback_id":"","state":{"values":{"acceptance_criteria":{"BCC":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"Dinner is ordered and tasty","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"additional":{"S47AD":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"previous":{"Y4r7m":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"Dinner has to be tasty and I can't make up my mind. Help?","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"requirement":{"y1+":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I need to order dinner.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"title":{"8YZh":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"Give Me a Consult","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}}}},"hash":"1602539357.f6DHe3XD","clear_on_close":false,"notify_on_close":false,"root_view_id":"V01CCCHC7U5","previous_view_id":"","app_id":"A01BJF00CAD","external_id":"","bot_id":"B01B63T6ZFD"},"action_id":"","api_app_id":"A01BJF00CAD","block_id":"","container":{"type":"","view_id":"","message_ts":"","attachment_id":0,"channel_id":"","is_ephemeral":false,"is_app_unfurl":false},"submission":null,"hash":"","is_cleared":false}`),
			ExpectedTitle: "Give Me a Consult",
			ExpectedBody: `h3. Requirement
I need to order dinner.

h3. Previous Efforts
Dinner has to be tasty and I can't make up my mind. Help?

h3. Acceptance Criteria
* Dinner is ordered and tasty`,
		},
		{
			Name:          "many acceptance criteria, additional details",
			Callback:      []byte(`{"type":"view_submission","token":"Rn1sVT099UjUeKclB3PkLT8t","callback_id":"","response_url":"","trigger_id":"1416756610774.1377252349923.ff1a76bce3db8f1d6f892f75bcb25f58","action_ts":"","team":{"id":"T01B37EA9T5","name":"","domain":"dptp-robot-testing"},"channel":{"id":"","created":0,"is_open":false,"is_group":false,"is_shared":false,"is_im":false,"is_ext_shared":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_mpim":false,"unlinked":0,"name_normalized":"","num_members":0,"priority":0,"user":"","name":"","creator":"","is_archived":false,"members":null,"topic":{"value":"","creator":"","last_set":0},"purpose":{"value":"","creator":"","last_set":0},"is_channel":false,"is_general":false,"is_member":false,"locale":""},"user":{"id":"U01B31ARZDG","team_id":"T01B37EA9T5","name":"skuznets","deleted":false,"color":"","real_name":"","tz_label":"","tz_offset":0,"profile":{"first_name":"","last_name":"","real_name":"","real_name_normalized":"","display_name":"","display_name_normalized":"","email":"","skype":"","phone":"","image_24":"","image_32":"","image_48":"","image_72":"","image_192":"","image_original":"","title":"","status_expiration":0,"team":"","fields":[]},"is_bot":false,"is_admin":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_ultra_restricted":false,"is_stranger":false,"is_app_user":false,"is_invited_user":false,"has_2fa":false,"has_files":false,"presence":"","locale":"","updated":0,"enterprise_user":{"id":"","enterprise_id":"","enterprise_name":"","is_admin":false,"is_owner":false,"teams":null}},"original_message":{"replace_original":false,"delete_original":false,"blocks":null},"message":{"replace_original":false,"delete_original":false,"blocks":null},"name":"","value":"","message_ts":"","attachment_id":"","actions":[],"view":{"ok":false,"error":"","id":"V01CU3D2A73","team_id":"T01B37EA9T5","type":"modal","title":{"type":"plain_text","text":"Request a Consultation","emoji":true},"close":{"type":"plain_text","text":"Cancel","emoji":true},"submit":{"type":"plain_text","text":"Submit","emoji":true},"blocks":[{"type":"section","text":{"type":"plain_text","text":"When a team has complex or involved requirements from the infrastructure, the Test Platform team can provide an engineer's time to consult on how to best achieve those goals. Use this form to request a consultation.","emoji":true},"block_id":"zrDa"},{"type":"section","text":{"type":"plain_text","text":"Users that wish to ask a question from the Test Platform Help-Desk engineer should use the question form instead.","emoji":true},"block_id":"yIBe","accessory":{"type":"button","text":{"type":"plain_text","text":"Ask a Question","emoji":true},"action_id":"MGG","value":"question"}},{"type":"divider","block_id":"fwY8"},{"type":"input","block_id":"title","label":{"type":"plain_text","text":"Provide a one-line summary for this consultation:","emoji":true},"element":{"type":"plain_text_input","action_id":"xFGTt"}},{"type":"input","block_id":"requirement","label":{"type":"plain_text","text":"Explain your goals (what are you trying to achieve using the test platform?):","emoji":true},"element":{"type":"plain_text_input","action_id":"6v7u","multiline":true}},{"type":"input","block_id":"previous","label":{"type":"plain_text","text":"Explain what you've tried already and list any documents that were helpful or insufficient:","emoji":true},"element":{"type":"plain_text_input","action_id":"XwW0","multiline":true}},{"type":"input","block_id":"acceptance_criteria","label":{"type":"plain_text","text":"Provide acceptance criteria (one per line) for this consultation, focusing on what is to be achieved, not how:","emoji":true},"element":{"type":"plain_text_input","action_id":"ec8","multiline":true}},{"type":"input","block_id":"additional","label":{"type":"plain_text","text":"Provide any additional information:","emoji":true},"element":{"type":"plain_text_input","action_id":"aPFdZ","multiline":true},"optional":true}],"private_metadata":"consultation","callback_id":"","state":{"values":{"acceptance_criteria":{"ec8":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"something simple is done\nI didn't have to do anything to achieve it","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"additional":{"aPFdZ":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I'll bug you forever while we work on this.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"previous":{"XwW0":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I have tried nothing and looked at no docs.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"requirement":{"6v7u":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"I would like to do something really simple.","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}},"title":{"xFGTt":{"action_id":"","block_id":"","type":"plain_text_input","text":{"type":"","text":""},"value":"Please Help Me","action_ts":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","initial_option":{"text":null,"value":""},"initial_user":"","initial_channel":"","initial_conversation":"","initial_date":""}}}},"hash":"1602538261.7V8X4IBr","clear_on_close":false,"notify_on_close":false,"root_view_id":"V01CU3D2A73","previous_view_id":"","app_id":"A01BJF00CAD","external_id":"","bot_id":"B01B63T6ZFD"},"action_id":"","api_app_id":"A01BJF00CAD","block_id":"","container":{"type":"","view_id":"","message_ts":"","attachment_id":0,"channel_id":"","is_ephemeral":false,"is_app_unfurl":false},"submission":null,"hash":"","is_cleared":false}`),
			ExpectedTitle: "Please Help Me",
			ExpectedBody: `h3. Requirement
I would like to do something really simple.

h3. Previous Efforts
I have tried nothing and looked at no docs.

h3. Acceptance Criteria
* something simple is done
* I didn't have to do anything to achieve it

h3. Additional Details
I'll bug you forever while we work on this.`,
		},
	})
}

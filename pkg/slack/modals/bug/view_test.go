package bug

import (
	"encoding/json"
	"testing"

	jiraapi "github.com/andygrunwald/go-jira"
	"github.com/google/go-cmp/cmp"
	"github.com/sirupsen/logrus"
	"github.com/slack-go/slack"

	"github.com/openshift/ci-tools/pkg/jira"
	"github.com/openshift/ci-tools/pkg/slack/interactions"
	"github.com/openshift/ci-tools/pkg/slack/modals"
	"github.com/openshift/ci-tools/pkg/slack/modals/modaltesting"
)

func TestValidateSubmissionHandler(t *testing.T) {
	var testCases = []struct {
		name            string
		callback        []byte
		expectedHandled bool
		expectedPayload []byte
		expectedError   bool
	}{
		{
			name:            "valid because specific component chosen",
			callback:        []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1414625255638.1377252349923.b936c322ff12440681d95c4d9d202a60","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"release_controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"Release Controller"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":""}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":""}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
			expectedHandled: false,
			expectedPayload: nil,
			expectedError:   false,
		},
		{
			name:            "valid because other component chosen and written in",
			callback:        []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1414625255638.1377252349923.b936c322ff12440681d95c4d9d202a60","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"release_controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":""}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"component"}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
			expectedHandled: false,
			expectedPayload: nil,
			expectedError:   false,
		},
		{
			name:            "invalid because other component chosen and not written in",
			callback:        []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1414625255638.1377252349923.b936c322ff12440681d95c4d9d202a60","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"release_controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":""}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":""}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"input"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
			expectedHandled: true,
			expectedPayload: []byte(`{"response_action":"errors","errors":{"optional":"Provide a description of the other component."}}`),
			expectedError:   false,
		},
	}

	for _, testCase := range testCases {
		t.Run(testCase.name, func(t *testing.T) {
			var callback slack.InteractionCallback
			if err := json.Unmarshal(testCase.callback, &callback); err != nil {
				t.Errorf("%s: failed to unmarshal payload: %v", testCase.name, err)
				return
			}
			handled, out, err := validateSubmissionHandler().Handle(&callback, logrus.WithField("test", testCase.name))
			if expected, actual := testCase.expectedHandled, handled; expected != actual {
				t.Errorf("%s: expected handled %v but got %v", testCase.name, expected, actual)
			}
			if diff := cmp.Diff(string(testCase.expectedPayload), string(out)); diff != "" {
				t.Errorf("%s: got incorrect payload: %v", testCase.name, diff)
			}
			if testCase.expectedError && err == nil {
				t.Errorf("%s: expected an error but got none", testCase.name)
			}
			if !testCase.expectedError && err != nil {
				t.Errorf("%s: expected no error but got one: %v", testCase.name, err)
			}
		})
	}
}

func TestProcessSubmissionHandler(t *testing.T) {
	happyPath := modaltesting.SubmissionTestCase{
		Name:     "happy path with custom component",
		Callback: []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1445212076624.1377252349923.6db817174c902b85a7eac0d8f5613d3e","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"Release Controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":"Other"}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something right!"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"I'm on fire."}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Component"}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Every time, just push the button."}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something wrong!"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Title"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
		Filer: jira.NewFake(map[jira.IssueRequest]jira.IssueResponse{
			{
				IssueType: "Bug",
				Title:     "My Title",
				Description: `h3. Symptomatic Behavior
Something wrong!

h3. Expected Behavior
Something right!

h3. Impact
I'm on fire.

h3. Category
Other: My Component

h3. How to Reproduce
Every time, just push the button.`,
				Reporter: "U01B31ARZDG",
			}: {
				Issue: &jiraapi.Issue{Key: "WHOA-123"},
				Error: nil,
			},
		}),
		Updater: modals.NewFake([]modals.ViewUpdate{
			{
				ViewUpdateRequest: modals.ViewUpdateRequest{
					View:       modals.JiraView("WHOA-123"),
					ExternalID: "",
					Hash:       "", // updated unconditionally, should be empty
					ViewID:     "V01BYJ3JXN3",
				},
				ViewUpdateResponse: modals.ViewUpdateResponse{
					Response: &slack.ViewResponse{},
					Error:    nil,
				},
			},
		}),
		ExpectedPayload: []byte(`{"response_action":"update","view":{"type":"modal","title":{"type":"plain_text","text":"Creating Jira Issue..."},"blocks":[{"type":"section","text":{"type":"mrkdwn","text":"A Jira issue is being filed, please do not close this window..."}}],"private_metadata":"jira_pending"}}`),
		ExpectedError:   false,
	}
	modaltesting.ValidateSubmission(t, interactions.HandlerFromPartial(processSubmissionHandler(happyPath.Filer, happyPath.Updater)), happyPath)
}

func TestIssueParameters(t *testing.T) {
	parameters := issueParameters()
	modaltesting.ValidateBlockIds(t, View(), parameters.Fields...)
	modaltesting.ValidateParameterProcessing(t, parameters, []modaltesting.ProcessTestCase{
		{
			Name:          "custom component",
			Callback:      []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1445212076624.1377252349923.6db817174c902b85a7eac0d8f5613d3e","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"Release Controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"Other"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":""}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something right!"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"I'm on fire."}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Component"}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Every time, just push the button."}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something wrong!"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Title"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
			ExpectedTitle: "My Title",
			ExpectedBody: `h3. Symptomatic Behavior
Something wrong!

h3. Expected Behavior
Something right!

h3. Impact
I'm on fire.

h3. Category
Other: My Component

h3. How to Reproduce
Every time, just push the button.`,
		},
		{
			Name:          "extant component",
			Callback:      []byte(`{"action_id":"","action_ts":"","actions":[],"api_app_id":"A01BJF00CAD","attachment_id":"","block_id":"","callback_id":"","channel":{"created":0,"creator":"","id":"","is_archived":false,"is_channel":false,"is_ext_shared":false,"is_general":false,"is_group":false,"is_im":false,"is_member":false,"is_mpim":false,"is_open":false,"is_org_shared":false,"is_pending_ext_shared":false,"is_private":false,"is_shared":false,"locale":"","members":null,"name":"","name_normalized":"","num_members":0,"priority":0,"purpose":{"creator":"","last_set":0,"value":""},"topic":{"creator":"","last_set":0,"value":""},"unlinked":0,"user":""},"container":{"attachment_id":0,"channel_id":"","is_app_unfurl":false,"is_ephemeral":false,"message_ts":"","type":"","view_id":""},"hash":"","is_cleared":false,"message":{"blocks":null,"delete_original":false,"replace_original":false},"message_ts":"","name":"","original_message":{"blocks":null,"delete_original":false,"replace_original":false},"response_url":"","submission":null,"team":{"domain":"dptp-robot-testing","id":"T01B37EA9T5","name":""},"token":"Rn1sVT099UjUeKclB3PkLT8t","trigger_id":"1445212076624.1377252349923.6db817174c902b85a7eac0d8f5613d3e","type":"view_submission","user":{"color":"","deleted":false,"enterprise_user":{"enterprise_id":"","enterprise_name":"","id":"","is_admin":false,"is_owner":false,"teams":null},"has_2fa":false,"has_files":false,"id":"U01B31ARZDG","is_admin":false,"is_app_user":false,"is_bot":false,"is_invited_user":false,"is_owner":false,"is_primary_owner":false,"is_restricted":false,"is_stranger":false,"is_ultra_restricted":false,"locale":"","name":"skuznets","presence":"","profile":{"display_name":"","display_name_normalized":"","email":"","fields":[],"first_name":"","image_192":"","image_24":"","image_32":"","image_48":"","image_72":"","image_original":"","last_name":"","phone":"","real_name":"","real_name_normalized":"","skype":"","status_expiration":0,"team":"","title":""},"real_name":"","team_id":"T01B37EA9T5","tz_label":"","tz_offset":0,"updated":0},"value":"","view":{"app_id":"A01BJF00CAD","blocks":[{"block_id":"kS/","text":{"emoji":true,"text":"Use this form to report a bug in the test platform or infrastructure.","type":"plain_text"},"type":"section"},{"accessory":{"action_id":"hqO4","text":{"emoji":true,"text":"Ask a Question","type":"plain_text"},"type":"button","value":"question"},"block_id":"nKpi","text":{"emoji":true,"text":"Please be certain that what you are reporting is a bug in the system. If it's not clear, please ask a question from the Test Platform Help-Desk engineer using the question form instead.","type":"plain_text"},"type":"section"},{"block_id":"2YZkQ","type":"divider"},{"block_id":"title","element":{"action_id":"EU7e8","type":"plain_text_input"},"label":{"emoji":true,"text":"Provide a title for this bug:","type":"plain_text"},"type":"input"},{"block_id":"category","element":{"action_id":"Ceww","options":[{"text":{"emoji":true,"text":"CI Jobs","type":"plain_text"},"value":"jobs"},{"text":{"emoji":true,"text":"CI Search","type":"plain_text"},"value":"search"},{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"Release Controller"},{"text":{"emoji":true,"text":"Other","type":"plain_text"},"value":"other"}],"placeholder":{"emoji":true,"text":"Select a category...","type":"plain_text"},"type":"static_select"},"label":{"emoji":true,"text":"What test infrastructure component is affected?","type":"plain_text"},"type":"input"},{"block_id":"optional","element":{"action_id":"DCgA","type":"plain_text_input"},"label":{"emoji":true,"text":"If other, what best describes the bugged component?","type":"plain_text"},"optional":true,"type":"input"},{"block_id":"yoR","type":"divider"},{"block_id":"symptom","element":{"action_id":"G=Vl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What incorrect behavior did you notice?","type":"plain_text"},"type":"input"},{"block_id":"expected","element":{"action_id":"BFSg5","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What behavior did you expect instead?","type":"plain_text"},"type":"input"},{"block_id":"impact","element":{"action_id":"+2dWl","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"What is the impact of this bug? How many jobs or users are impacted?","type":"plain_text"},"type":"input"},{"block_id":"reproduction","element":{"action_id":"Cv9","multiline":true,"type":"plain_text_input"},"label":{"emoji":true,"text":"Is this bug reproducible? If so, how?","type":"plain_text"},"type":"input"}],"bot_id":"B01B63T6ZFD","callback_id":"","clear_on_close":false,"close":{"emoji":true,"text":"Cancel","type":"plain_text"},"error":"","external_id":"","hash":"1602467948.iWjOP1Z9","id":"V01BYJ3JXN3","notify_on_close":false,"ok":false,"previous_view_id":"","private_metadata":"bug","root_view_id":"V01BYJ3JXN3","state":{"values":{"category":{"Ceww":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":{"emoji":true,"text":"Release Controller","type":"plain_text"},"value":"Release Controller"},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"static_select","value":""}},"expected":{"BFSg5":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something right!"}},"impact":{"+2dWl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"I'm on fire."}},"optional":{"DCgA":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Component"}},"reproduction":{"Cv9":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Every time, just push the button."}},"symptom":{"G=Vl":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"Something wrong!"}},"title":{"EU7e8":{"action_id":"","action_ts":"","block_id":"","initial_channel":"","initial_conversation":"","initial_date":"","initial_option":{"text":null,"value":""},"initial_user":"","selected_channel":"","selected_channels":null,"selected_conversation":"","selected_conversations":null,"selected_date":"","selected_option":{"text":null,"value":""},"selected_options":null,"selected_user":"","selected_users":null,"text":{"text":"","type":""},"type":"plain_text_input","value":"My Title"}}}},"submit":{"emoji":true,"text":"Submit","type":"plain_text"},"team_id":"T01B37EA9T5","title":{"emoji":true,"text":"File a Bug","type":"plain_text"},"type":"modal"}}`),
			ExpectedTitle: "My Title",
			ExpectedBody: `h3. Symptomatic Behavior
Something wrong!

h3. Expected Behavior
Something right!

h3. Impact
I'm on fire.

h3. Category
Release Controller

h3. How to Reproduce
Every time, just push the button.`,
		},
	})
}
